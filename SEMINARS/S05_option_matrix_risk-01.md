### Матрица вариантов (Option Matrix) для **R-01: Abuse/DoS публичных auth-эндпоинтов**

---

#### 0) Контекст риска

**Risk-ID**: R-01
**Threat**: D
**DFD element/edge**: Интернет → API (/verify-email, /register)
**NFR link (ID)**: NFR-001, NFR-002, need NFR: RateLimit-register
**L×I (1-5)**: L=4, I=4, Score=16
**Ограничения/предпосылки**: Публичный API, часто встречаемая угроза, простота автоматизации, важность защиты от DoS-атак на критичный путь регистрации.

---

#### 1) Критерии и шкалы

| Критерий                   | Шкала 1-5 | Описание                                                                                 |
| -------------------------- | --------- | ---------------------------------------------------------------------------------------- |
| **Security impact**        | ↑ (1-5)   | Насколько альтернатива снижает риск (предотвращает/обнаруживает/сдерживает)              |
| **Blast radius reduction** | ↑ (1-5)   | Насколько сужает возможный ущерб (только один тенант/аккаунт/фича вместо всего сервиса). |
| **Complexity**             | ↓ (1-5)   | Сложность внедрения (код/конфиг/политики)                                                |
| **Time-to-mitigate**       | ↓ (1-5)   | Сколько времени до эффекта (в днях/спринтах)                                             |
| **Dependencies**           | ↓ (1-5)   | Внешние/внутренние зависимости (команды, провайдеры, миграции)                           |

---

#### 2) Таблица сравнения вариантов

| Alternative | Summary (1-2 фразы)                                                                           | Security impact (↑, 1-5) | Blast radius reduction (↑, 1-5) | Complexity (↓, 1-5) | Time-to-mitigate (↓, 1-5) | Dependencies (↓, 1-5) | Benefit | Cost | Net | Notes                                                                                          |
| ----------- | --------------------------------------------------------------------------------------------- | ------------------------ | ------------------------------- | ------------------- | ------------------------- | --------------------- | ------- | ---- | --- | ---------------------------------------------------------------------------------------------- |
| **A**       | Введение глобальных лимитов на количество запросов и размер тела для всех auth-эндпоинтов.    | 4                        | 5                               | 2                   | 3                         | 4                     | 9       | 9    | 0   | Простое решение, не зависит от внешних провайдеров, но требует настройки лимитов               |
| **B**       | Введение лимитов на запросы на уровне каждого endpoint (например, /register и /verify-email). | 4                        | 5                               | 3                   | 3                         | 4                     | 9       | 10   | -1  | Больше гибкости, но сложнее в настройке для каждого эндпоинта                                  |
| **C**       | Использование стороннего решения для защиты от DoS-атак (например, WAF).                      | 5                        | 4                               | 4                   | 4                         | 5                     | 9       | 13   | -4  | Хорошо защищает, но зависит от внешнего провайдера, требует времени для интеграции и настройки |

---

#### 3) Тай-брейкеры при равенстве Net

* **Compliance/Privacy**: Никаких дополнительных требований по приватности не возникает.
* **Maintainability**: Вариант A проще в поддержке, так как настройки более централизованы.
* **Team fit**: Решение A лучше подходит для команды с опытом настройки инфраструктуры, не требуя дополнительных внешних интеграций.
* **Observability**: Все варианты имеют высокую наблюдаемость (логи, метрики).
* **Rollback safety**: Вариант A имеет наименьшие риски отката, так как изменения происходят в рамках конфигурации.

---

#### 4) Решение

**Chosen alternative**: **A - Global & per-route rate-limits + body-size limits**
**Почему**: Это решение проще внедрить и поддерживать в долгосрочной перспективе. Оно не зависит от внешних провайдеров, что позволяет лучше контролировать инфраструктуру. Вариант B более гибок, но добавляет дополнительную сложность, а C слишком зависит от внешнего поставщика, что увеличивает зависимость и стоимость.
**ADR candidate**: Rate Limiting на уровне auth-эндпоинтов.

**Связки**: Risk-ID R-01, NFR-ID NFR-001, NFR-002, DFD Internet→API.
**Следующие шаги**:

1. Внедрить глобальные лимиты на запросы и размеры тел для всех auth-эндпоинтов.
2. Настроить логирование и мониторинг лимитов на уровне сервера.
3. Протестировать решение в staging-среде.
4. Внедрить лимиты на уровне отдельного эндпоинта (/register, /verify-email).
5. Обновить документацию по API с информацией о лимитах.

---

